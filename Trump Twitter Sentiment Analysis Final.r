#???????????????? ??????????????
library(ggplot2)
library(lubridate)
library(scales)
library(tm)
library(stringr)
library(wordcloud)
library(syuzhet)
library(reshape2)
library(dplyr)

#???????????????? ?????? ???????????????????? ??????????????????
tweets <- read.csv(choose.files(), stringsAsFactors = FALSE)
tweets$date <- ymd_hms(tweets$date)
tweets$date <- with_tz(tweets$date, "America/Chicago")
f_tweets <- tweets %>% filter(date >= "2017-01-01" & date <= "2021-01-07", isRetweet == 'f')

#?????????????? ?????????????????? tweet
ggplot(data = f_tweets, aes(x = date)) +
  geom_histogram(aes(fill = ..count..)) +
  theme(legend.position = "none") +
  xlab("Time") + ylab("Number of Tweets") + 
  scale_fill_gradient(low = "midnightblue", high = "aquamarine4")

#???????????????????? ????????????????
nohandles <- str_replace_all(f_tweets$text, "@\\w+", "")
wordCorpus <- Corpus(VectorSource(nohandles))
wordCorpus <- tm_map(wordCorpus, removePunctuation)
wordCorpus <- tm_map(wordCorpus, content_transformer(tolower))
wordCorpus <- tm_map(wordCorpus, removeWords, stopwords("english"))
wordCorpus <- tm_map(wordCorpus, removeWords, c("amp","4yo", "3yo", "2yo"))
wordCorpus <- tm_map(wordCorpus, stripWhitespace)

removeURL <- function(x) gsub('https[[:alnum:]]*', '', x)
wordCorpus <- tm_map(wordCorpus, content_transformer(removeURL))


#???????????????????? wordcloud
pal <- brewer.pal(9,"BuPu")
pal <- pal[-(1:4)]

wordcloud(words = wordCorpus, scale=c(5,0.3), max.words=100, random.order=FALSE, 
          rot.per=0.35, use.r.layout=FALSE, colors = pal)

#???????????????????? ???????????? ?????????????????????????? ???????? ?????? tweets
mySentiment <- get_nrc_sentiment(f_tweets$text)
fs_tweets <- cbind(f_tweets, mySentiment)

#???????????? 
sentimentTotals <- data.frame(colSums(fs_tweets[,c(10:19)]))
names(sentimentTotals) <- "count"
sentimentTotals <- cbind("sentiment" = rownames(sentimentTotals), sentimentTotals)
rownames(sentimentTotals) <- NULL

#?????????????? ?????????????????? ???????? ?????????????????????????? ?????? ?????? ???? tweets
ggplot(data = sentimentTotals, aes(x = sentiment, y = count)) +
  geom_bar(aes(fill = sentiment), stat = "identity") +
  theme(legend.position = "none") +
  xlab("Sentiment") + ylab("Total Count") + ggtitle("Total Sentiment Score for All Tweets")

#?????????? ???????? ?????????????? ?????? ?????????????????? ??????????????????????
posnegtime <- fs_tweets %>% 
  group_by(date = cut(date, breaks="2 months")) %>%
  summarise(negative = mean(negative),
            positive = mean(positive)) %>% melt
names(posnegtime) <- c("date", "sentiment", "meanvalue")
posnegtime$sentiment = factor(posnegtime$sentiment,levels(posnegtime$sentiment)[c(2,1)])

#???????????????????? ???????????????????? ???????????????????? ?????? ?????? ??????????
ggplot(data = posnegtime, aes(x = as.Date(date), y = meanvalue, group = sentiment)) +
  geom_line(size = 2.5, alpha = 0.7, aes(color = sentiment)) +
  geom_point(size = 0.5) +
  ylim(0, NA) + 
  scale_colour_manual(values = c("springgreen4", "firebrick3")) +
  theme(legend.title=element_blank(), axis.title.x = element_blank()) +
  scale_x_date(breaks = date_breaks("2 months"), 
               labels = date_format("%Y-%b")) +
  ylab("Average sentiment score") + 
  ggtitle("Sentiment Over Time")

#???????????????????????? ?????????????????? ?????? ?????????????? ?????????????????????????? ???????? ???? ???????? ????????????
fs_tweets$month <- month(fs_tweets$date, label = TRUE)
monthlysentiment <- fs_tweets %>% group_by(month) %>% 
  summarise(anger = mean(anger), 
            anticipation = mean(anticipation), 
            disgust = mean(disgust), 
            fear = mean(fear), 
            joy = mean(joy), 
            sadness = mean(sadness), 
            surprise = mean(surprise), 
            trust = mean(trust)) %>% melt
names(monthlysentiment) <- c("month", "sentiment", "meanvalue")

#???????????????????? ???????????????????? ???????????????????? ???????? ???? ???????????????? ???????? ????????????
ggplot(data = monthlysentiment, aes(x = month, y = meanvalue, group = sentiment)) +
  geom_line(size = 2.5, alpha = 0.7, aes(color = sentiment)) +
  geom_point(size = 0.5) +
  ylim(0, NA) +
  theme(legend.title=element_blank(), axis.title.x = element_blank()) +
  ylab("Average sentiment score") + 
  ggtitle("Sentiment During the Year")



